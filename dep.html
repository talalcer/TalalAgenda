<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ - Ø·Ù„Ø§Ù„ Ø§Ù„Ø³Ø±ÙŠØªÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
         :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #e67e22;
            --bg-color: #f4f7f6;
            --white: #ffffff;
        }
        
        * {
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
            user-select: none;
            /* Ù…Ù†Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ */
        }
        
        body {
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
        }
        /* Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
        
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--white);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .logo-container {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid var(--accent-color);
        }
        
        .logo-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .app-title {
            text-align: center;
        }
        
        .app-title h1 {
            margin: 0;
            color: var(--primary-color);
        }
        
        .app-title p {
            margin: 5px 0;
            font-size: 0.9em;
            color: #666;
        }
        /* ØªÙ†Ø³ÙŠÙ‚ Ù‚Ø³Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª */
        
        .instructions-panel {
            background: var(--white);
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid #27ae60;
            /* ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù„ÙˆÙ† Ù„Ù„Ø£Ø®Ø¶Ø± Ù„ÙŠØ¯Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© */
        }
        
        .instructions-header {
            background: #27ae60;
            color: white;
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .instructions-content {
            padding: 20px;
            display: none;
            /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
            line-height: 1.8;
        }
        
        .instructions-content.active {
            display: block;
        }
        
        .step-card {
            border-right: 4px solid var(--accent-color);
            background: #f9f9f9;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
        }
        
        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        .info-table th,
        .info-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        
        .info-table th {
            background-color: #eee;
        }
        
        .note-box {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        /* Ù‚Ø³Ù… Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªØ·ÙˆØ± */
        
        .settings-panel {
            background: var(--white);
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid #ddd;
        }
        
        .settings-header {
            background: var(--secondary-color);
            color: white;
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .settings-content {
            padding: 20px;
            display: none;
            /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
        }
        
        .settings-content.active {
            display: block;
        }
        
        .group-box {
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .group-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--accent-color);
        }
        
        .input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        input[type="date"],
        input[type="text"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        /* Ø³Ø­Ø¨ ÙˆØ¥ÙÙ„Ø§Øª */
        
        .upload-area {
            border: 2px dashed var(--accent-color);
            background: #fff9f5;
            padding: 40px;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .upload-area:hover {
            background: #fff0e6;
        }
        
        .btn-process {
            display: block;
            width: 100%;
            padding: 15px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .btn-process:hover {
            background: #219150;
        }
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª */
        
        #log-area {
            background: #222;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            margin-top: 20px;
            font-size: 0.85em;
            direction: ltr;
            text-align: left;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            border-top: 1px solid #ccc;
            color: #777;
        }
        
        .arrow-icon {
            transition: transform 0.3s;
        }
        
        .rotated {
            transform: rotate(180deg);
        }
    </style>
</head>

<body>

    <header>
        <div class="logo-container">
            <img src="https://talalcer.github.io/fuel-img/mizan.png" alt="Company Logo">
        </div>

        <div class="app-title">
            <h1>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ</h1>
            <p>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; Ø·Ù„Ø§Ù„ Ø§Ù„Ø³Ø±ÙŠØªÙŠ <br> talalcer@gmail.com</p>
        </div>

        <div class="logo-container">
            <img src="https://talalcer.github.io/fuel-img/talal512.png" alt="Personal Logo">
        </div>
    </header>

    <div class="container">
        <div class="instructions-panel">
            <div class="instructions-header" onclick="uiManager.toggleInstructions()">
                <span>ğŸ“– ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ·Ø¨ÙŠÙ‚ Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ</span>
                <span class="arrow-icon" id="ins-arrow">â–¼</span>
            </div>
            <div class="instructions-content" id="instructionsContent">

                <div class="step-card">
                    <strong>1. ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ù„Ù:</strong>ÙŠØªÙ… ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø¨Ù‡ Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· . <a href="https://docs.google.com/spreadsheets/d/1u4UQw1xUVIpKeLODgGh9h8tcdeCVnv_X/export?format=xlsx">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù.</a>
                </div>
                <div class="step-card">
                    <strong>2. Ø´ÙŠØª (basic):</strong> ÙŠØ¬Ø¨ Ø£ÙˆÙ„Ø§Ù‹ Ø¶Ø¨Ø· Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŒ Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØŒ Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©ØŒ ÙˆØ·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù.
                    <table class="info-table">
                        <tr>
                            <th>Ø§Ù„Ù†ÙˆØ¹</th>
                            <th>Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</th>
                            <th>Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                        </tr>
                        <tr>
                            <td>Ø£Ø¬Ù‡Ø²Ø© ÙˆØ¢Ù„Ø§Øª</td>
                            <td>10 Ø³Ù†ÙˆØ§Øª</td>
                            <td>Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</td>
                        </tr>
                        <tr>
                            <td>Ø£Ø«Ø§Ø«</td>
                            <td>5 Ø³Ù†ÙˆØ§Øª</td>
                            <td>Ø¹Ù…Ù„ÙŠØ§Øª</td>
                        </tr>
                    </table>
                    <div class="note-box">
                        âš ï¸ **ØªÙ†Ø¨ÙŠÙ‡:** Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØµÙ…Ù…Ø© Ø¨Ù†Ø¸Ø§Ù… TableØŒ Ù„Ø°Ø§ Ø£Ø¶Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù†Ù‡Ø§ÙŠØ© ÙƒÙ„ Ø¬Ø¯ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¯ÙˆÙ† ØªØ±Ùƒ ØµÙÙˆÙ ÙØ§Ø±ØºØ©.
                    </div>
                </div>

                <div class="step-card">
                    <strong>3. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù :</strong> ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø´ÙŠØª dataØŒ Ø­ÙŠØ« ØªØ¹Ù…Ù„ Ø­Ù‚ÙˆÙ„ (Ø§Ù„ØªÙ…ÙˆÙŠÙ„ØŒ Ø§Ù„Ù…Ø±ÙƒØ²ØŒ Ø§Ù„Ù†ÙˆØ¹) Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© (List) Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡.
                </div>

                <div class="step-card">
                    <strong>4. Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©:</strong> Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ØŒ Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø£Ùˆ Ø§ÙØªØ­Ù‡ Ù…Ù† Ø§Ù„Ø¯Ø§Ø®Ù„ØŒ ÙˆØ³ÙŠÙ‚ÙˆÙ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ ÙˆÙ…Ø®ØµØµ Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ.
                </div>

            </div>
        </div>
        <div class="settings-panel">
            <div class="settings-header" onclick="uiManager.toggleSettings()">
                <span>Ø·Ø±ÙŠÙ‚Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ Ù‚Ø³Ø· Ø«Ø§Ø¨Øª (Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª)</span>
                <span class="arrow-icon" id="arrow">â–¼</span>
            </div>
            <div class="settings-content" id="settingsContent">
                <div class="group-box">
                    <div class="group-title">Ø§Ø®ØªØ§Ø± Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ</div>
                    <!-- <label><input type="radio" name="depway" value="day" checked> Ø¨Ø¯Ø§ÙŠØ© Ù…Ù† ÙŠÙˆÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©</label><br> -->
                    <label><input type="radio" name="depway" value="month" checked> Ø¨Ø¯Ø§ÙŠØ© Ù…Ù† Ø´Ù‡Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©</label><br>
                    <label><input type="radio" name="depway" value="period"> Ø¨Ø¯Ø§ÙŠØ© Ù…Ù† ÙØªØ±Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ©</label>
                </div>

                <div class="group-box">
                    <div class="group-title">Ø§Ø®ØªØ§Ø± Ù…Ø¯Ø© Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ</div>
                    <div class="input-row">
                        <label><input type="radio" name="depper" value="month" checked> Ø´Ù‡Ø± Ø¨Ø¯Ø§ÙŠØ© Ù…Ù†:</label>
                        <input type="date" id="date_month" onchange="uiManager.updateDates('month')">
                        <span>Ø¥Ù„Ù‰:</span>
                        <input type="text" id="end_month" readonly>
                    </div>
                    <div class="input-row">
                        <label><input type="radio" name="depper" value="quarter"> ÙØªØ±Ø© (Quarter) Ø¨Ø¯Ø§ÙŠØ© Ù…Ù†:</label>
                        <input type="date" id="date_quarter" onchange="uiManager.updateDates('quarter')">
                        <span>Ø¥Ù„Ù‰:</span>
                        <input type="text" id="end_quarter" readonly>
                    </div>
                    <div class="input-row">
                        <label><input type="radio" name="depper" value="year"> Ø³Ù†Ø© Ø¨Ø¯Ø§ÙŠØ© Ù…Ù†:</label>
                        <input type="date" id="date_year" onchange="uiManager.updateDates('year')">
                        <span>Ø¥Ù„Ù‰:</span>
                        <input type="text" id="end_year" readonly>
                    </div>
                </div>
            </div>
        </div>

        <div class="upload-area" id="dropZone" onclick="document.getElementById('fileInput').click()">
            <p>Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª Ù…Ù„Ù Ø§Ù„Ø§ÙƒØ³ÙŠÙ„ Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</p>
            <input type="file" id="fileInput" hidden accept=".xlsx, .xls">
            <div id="fileNameDisplay" style="margin-top:10px; font-weight:bold; color:var(--accent-color);"></div>
        </div>

        <button class="btn-process" onclick="app.startProcessing()">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</button>

        <div id="log-area"></div>
    </div>

    <footer>
        ØªØµÙ…ÙŠÙ…: Ø·Ù„Ø§Ù„ Ø§Ù„Ø³Ø±ÙŠØªÙŠ &copy; | Talal Cerity 2025
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            const depwayRadios = document.querySelectorAll('input[name="depway"]');

            // Ø¬Ù„Ø¨ Ø§Ù„ØµÙ (div) Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ "Ø´Ù‡Ø± Ø¨Ø¯Ø§ÙŠØ© Ù…Ù†" Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø±Ø§Ø¯ÙŠÙˆ Ø«Ù… Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£Ø¨
            const monthRow = document.querySelector('input[name="depper"][value="month"]').closest('.input-row');

            // Ø¬Ù„Ø¨ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¯Ø§Ø®Ù„ Ù‡Ø°Ø§ Ø§Ù„ØµÙ Ù„ØªØ¹Ø·ÙŠÙ„Ù‡Ø§
            const monthRadio = monthRow.querySelector('input[type="radio"]');
            const dateInput = document.getElementById('date_month');

            // Ø¬Ù„Ø¨ Ø®ÙŠØ§Ø± Ø§Ù„ÙØªØ±Ø© (Quarter) Ù„Ø¬Ø¹Ù„Ù‡ Ù…Ø®ØªØ§Ø±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
            const quarterRadio = document.querySelector('input[name="depper"][value="quarter"]');

            // 2. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø£Ø­Ø¯Ø§Ø«
            depwayRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const selectedValue = this.value;

                    if (selectedValue === 'period') {
                        // --- Ø­Ø§Ù„Ø©: Ø§Ø®ØªÙŠØ§Ø± "ÙØªØ±Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ©" ---

                        // Ø£. ØªØºÙŠÙŠØ± Ù…Ø¸Ù‡Ø± Ø§Ù„Ù€ Div (Ø¬Ø¹Ù„Ù‡ Ø¨Ø§Ù‡ØªØ§Ù‹ ÙˆØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù†Ù‚Ø±)
                        monthRow.style.opacity = "0.5"; // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø´ÙØ§ÙÙŠØ©
                        monthRow.style.pointerEvents = "none"; // Ù…Ù†Ø¹ Ø£ÙŠ ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø±Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ Div

                        // Ø¨. ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ø±Ø³Ù…ÙŠØ§Ù‹
                        monthRadio.disabled = true;
                        dateInput.disabled = true;

                        // Ø¬. ØªÙØ¹ÙŠÙ„ Ø®ÙŠØ§Ø± Ø§Ù„ÙØªØ±Ø©
                        quarterRadio.checked = true;

                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
                        if (typeof uiManager !== 'undefined' && uiManager.updateDates) {
                            uiManager.updateDates('quarter');
                        }

                    } else {
                        // --- Ø­Ø§Ù„Ø©: Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù€ "Ø´Ù‡Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©" ---

                        // Ø£. Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø¸Ù‡Ø± Ø§Ù„Ù€ Div Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
                        monthRow.style.opacity = "1";
                        monthRow.style.pointerEvents = "auto";

                        // Ø¨. Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø·ÙŠÙ„ Ø¹Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©
                        monthRadio.disabled = false;
                        dateInput.disabled = false;

                        // Ø¬. ØªÙØ¹ÙŠÙ„ Ø®ÙŠØ§Ø± Ø§Ù„Ø´Ù‡Ø±
                        monthRadio.checked = true;

                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
                        if (typeof uiManager !== 'undefined' && uiManager.updateDates) {
                            uiManager.updateDates('month');
                        }
                    }
                });
            });
        });


        /**
         * Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙˆØ§Ù„Ø£Ù…Ø§Ù†
         */
        (function protect() {
            document.addEventListener('contextmenu', e => e.preventDefault());
            document.onkeydown = function(e) {
                if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74)) || (e.ctrlKey && e.keyCode == 85)) {
                    return false;
                }
            };
            document.addEventListener('copy', e => e.preventDefault());
        })();

        /**
         * ÙƒÙ„Ø§Ø³ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (UI Manager)
         */
        class UIManager {
            constructor() {
                this.logElement = document.getElementById('log-area');
            }

            // Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª
            toggleInstructions() {
                const content = document.getElementById('instructionsContent');
                const arrow = document.getElementById('ins-arrow');
                content.classList.toggle('active');
                arrow.classList.toggle('rotated');
            }

            toggleSettings() {
                const content = document.getElementById('settingsContent');
                const arrow = document.getElementById('arrow');
                content.classList.toggle('active');
                arrow.classList.toggle('rotated');
            }

            log(message, type = 'info') {
                const time = new Date().toLocaleTimeString();
                const msgHtml = `<div>[${time}] ${type.toUpperCase()}: ${message}</div>`;
                this.logElement.innerHTML += msgHtml;
                this.logElement.scrollTop = this.logElement.scrollHeight;
            }

            updateDates(type) {
                const input = document.getElementById(`date_${type}`);
                const endInput = document.getElementById(`end_${type}`);
                let date = new Date(input.value);

                if (isNaN(date.getTime())) return;

                // Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„ÙŠÙˆÙ… Ø¹Ù„Ù‰ 1
                date.setDate(1);
                input.value = date.toISOString().split('T')[0];

                let endDate = new Date(date);
                if (type === 'month') {
                    endDate = new Date(date.getFullYear(), date.getMonth() + 1, 1);
                } else if (type === 'quarter') {
                    let quarterEndMonth = (Math.floor(date.getMonth() / 3) + 1) * 3;
                    endDate = new Date(date.getFullYear(), quarterEndMonth, 1);
                } else if (type === 'year') {
                    endDate = new Date(date.getFullYear(), 12, 1);
                }
                endInput.value = endDate.toISOString().split('T')[0];
            }
        }

        const uiManager = new UIManager();

        /**
         * ÙƒÙ„Ø§Ø³ Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Depreciation App) - ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù€ Encapsulation
         */
        class DepreciationApp {
            constructor() {
                this.selectedFile = null;
                this.data = {
                    mdata: [],
                    type: []
                };
                this.setupListeners();
            }

            setupListeners() {
                const fileInput = document.getElementById('fileInput');
                const dropZone = document.getElementById('dropZone');

                fileInput.addEventListener('change', (e) => this.handleFiles(e.target.files));
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = '#2ecc71';
                });
                dropZone.addEventListener('dragleave', () => {
                    dropZone.style.borderColor = '#e67e22';
                });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.handleFiles(e.dataTransfer.files);
                });
            }

            handleFiles(files) {
                if (files.length > 0) {
                    this.selectedFile = files[0];
                    document.getElementById('fileNameDisplay').innerText = "ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: " + this.selectedFile.name;
                    uiManager.log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ${this.selectedFile.name}`);
                }
            }

            async startProcessing() {
                if (!this.selectedFile) {
                    uiManager.log("Ø®Ø·Ø£: ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹", "error");
                    return;
                }

                try {
                    uiManager.log("Ø¨Ø¯Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù...");
                    const workbook = await this.readFile(this.selectedFile);

                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    this.data.mdata = XLSX.utils.sheet_to_json(workbook.Sheets['data'] || workbook.Sheets[Object.keys(workbook.Sheets)[0]]);
                    this.data.type = XLSX.utils.sheet_to_json(workbook.Sheets['basic'] || workbook.Sheets[Object.keys(workbook.Sheets)[1]]);

                    uiManager.log("Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©...");
                    this.processLogic();

                } catch (err) {
                    uiManager.log(`ÙØ´Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: ${err.message}`, "error");
                }
            }

            readFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(XLSX.read(e.target.result, {
                        type: 'binary',
                        cellDates: true
                    }));
                    reader.onerror = reject;
                    reader.readAsBinaryString(file);
                });
            }



            processLogic() {
                const depway = document.querySelector('input[name="depway"]:checked').value;
                const depper = document.querySelector('input[name="depper"]:checked').value;

                // dstart & dend Ù…Ù† Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª
                const dstart = new Date(document.getElementById(`date_${depper}`).value);
                const dend = new Date(document.getElementById(`end_${depper}`).value);

                if (isNaN(dstart) || isNaN(dend)) {
                    throw new Error("ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©");
                }

                const resultData = this.data.mdata.map(row => {
                    try {
                        // ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ ÙˆØªÙˆØ­ÙŠØ¯Ù‡
                        const cleanText = (text) => {
                            if (!text) return "";
                            return text.toString()
                                .trim() // Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©
                                .replace(/\s+/g, ' ') // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© Ø¥Ù„Ù‰ Ù…Ø³Ø§ÙØ© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
                                .replace(/[Ø£Ø¥Ø¢]/g, 'Ø§') // ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø£Ù„Ù
                                .replace(/Ø©/g, 'Ù‡'); // ØªÙˆØ­ÙŠØ¯ Ø§Ù„ØªØ§Ø¡ Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø© ÙˆØ§Ù„Ù‡Ø§Ø¡
                        };

                        // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­Ø¯Ø«)
                        const rowTypeClean = cleanText(row['Ø§Ù„Ù†ÙˆØ¹']);
                        const typeInfo = this.data.type.find(t => cleanText(t['Ø§Ù„Ù†ÙˆØ¹']) === rowTypeClean);

                        const life = typeInfo ? parseFloat(typeInfo['Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ']) : 0;
                        row['Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ'] = life;

                        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¬Ø¯ Ø§Ù„Ù‚ÙŠÙ…Ø©ØŒ Ù†ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø© ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
                        if (life === 0) {
                            uiManager.log(`ØªÙ†Ø¨ÙŠÙ‡: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù…Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ù†ÙˆØ¹: "${row['Ø§Ù„Ù†ÙˆØ¹']}"`, "warn");
                        }

                        // 2. Ø­Ø³Ø§Ø¨ astart Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ depway
                        let astart = new Date(row['Ø§Ù„ØªØ§Ø±ÙŠØ®']);
                        if (depway === 'month') {
                            astart.setDate(0);
                        } else if (depway === 'period') {
                            let qStartMonth = Math.floor(astart.getMonth() / 3) * 3;
                            astart = new Date(astart.getFullYear(), qStartMonth, 1);
                        }

                        // --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ø­Ø³Ø§Ø¨ aend ---
                        // 1. Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø£Ø´Ù‡Ø± (ØªÙˆØ¶Ø¹ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¯Ø§Ù„Ø© Ø£Ùˆ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©)
                        const getMonthsDiff = (date1, date2) => {
                            if (!date1 || !date2) return 0;
                            let months;
                            months = (date2.getFullYear() - date1.getFullYear()) * 12;
                            months -= date1.getMonth();
                            months += date2.getMonth();
                            months += 1; // Ù„Ø¬Ø¹Ù„ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø­Ø³ÙˆØ¨Ø§Ù‹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø£ÙŠØ§Ù… ÙƒÙƒØ³Ø± Ù…Ù† Ø§Ù„Ø´Ù‡Ø± (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªÙˆØ³Ø· 30.4167 ÙŠÙˆÙ… Ù„Ù„Ø´Ù‡Ø±)
                            // Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ø¯Ù‚Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©
                            // const dayDiff = date2.getDate() - date1.getDate();
                            // months += dayDiff / 30.4167;

                            return months <= 0 ? 0 : months;
                            // return months < 0 ? 0 : (months === 0 ? 1 : months);
                        };

                        // --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ø­Ø³Ø§Ø¨ aend ---
                        let aend = new Date(astart); // Ù†Ø³Ø® ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©

                        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© (ØªØ¹Ù…Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø¯Ù‚Ø© Ù…Ø¹ Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ³Ø©)
                        const fullYears = Math.floor(life);
                        aend.setFullYear(aend.getFullYear() + fullYears);

                        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØ³ÙˆØ± Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù…Ù† Ø§Ù„Ø³Ù†Ø© (Ø¥Ù† ÙˆØ¬Ø¯Øª) Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ 365.25
                        const remainingDays = Math.round((life - fullYears) * 365.25);
                        if (remainingDays > 0) {
                            aend.setDate(aend.getDate() + remainingDays);
                        }

                        // Ø·Ø±Ø­ ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯ Ù„Ø£Ù† ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ Ù‡Ùˆ Ø¢Ø®Ø± ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ù…Ø¯Ø© ÙˆÙ„ÙŠØ³ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ØªØ§Ù„ÙŠ
                        aend.setDate(aend.getDate() - 1);
                        // -------------------------------

                        row['ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ'] = astart;
                        row['ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ'] = aend;

                        // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨
                        let vdep = 0,
                            vaccum = 0,
                            notes = "";
                        const value = parseFloat(row['Ø§Ù„Ù‚ÙŠÙ…Ø©']) || 0;

                        // ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ Ù…Ù† Ø£ÙŠØ§Ù… Ø¥Ù„Ù‰ Ø£Ø´Ù‡Ø±
                        const totalMonths = life * 12;

                        if (dend < row['Ø§Ù„ØªØ§Ø±ÙŠØ®']) {
                            notes = "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø­Ù‚ Ù„ØªØ§Ø±ÙŠØ® Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ";
                        } else if (dstart > aend) {
                            vaccum = value;
                            notes = "Ø§Ù„Ø£ØµÙ„ Ø§Ù‡Ù„Ùƒ Ø¯ÙØªØ±ÙŠØ§";
                        } else if (dstart > astart && aend > dend) {
                            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© getMonthsDiff Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©
                            vaccum = value * (getMonthsDiff(astart, dend) / totalMonths);
                            vdep = value * (getMonthsDiff(dstart, dend) / totalMonths);
                        } else if (dstart > astart && aend < dend) {
                            vaccum = value;
                            vdep = value * (getMonthsDiff(dstart, aend) / totalMonths);
                            notes = "Ø§Ù„Ø£ØµÙ„ Ø§Ù‡Ù„Ùƒ Ø¯ÙØªØ±ÙŠØ§ Ø®Ù„Ø§Ù„ Ø§Ù„Ù…Ø¯Ø©";
                        } else if (dstart < astart && aend > dend) {
                            vaccum = value * (getMonthsDiff(astart, dend) / totalMonths);
                            vdep = vaccum;
                            notes = "Ø§ÙˆÙ„ Ù…Ø¯Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù‡Ù„Ø§Ùƒ Ø§Ù„Ø§ØµÙ„";
                        }
                        // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© (Ø¶Ø±Ø¨ ÙÙŠ 100 Ø«Ù… Ø§Ù„Ù‚Ø³Ù…Ø©) Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ù†Ø²Ù„ØªÙŠÙ† Ø¹Ø´Ø±ÙŠØªÙŠÙ†
                        row['Ø§Ù‡Ù„Ø§Ùƒ Ø§Ù„ÙØªØ±Ø©'] = Math.round(vdep * 100) / 100;
                        row['Ù…Ø®ØµØµ Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØªØ±Ø©'] = Math.round(vaccum * 100) / 100;
                        row['Ù…Ù„Ø§Ø­Ø¸Ø§Øª'] = notes;

                        return row;

                    } catch (e) {
                        uiManager.log(`Ø®Ø·Ø£ ÙÙŠ Ø³Ø·Ø±: ${e.message}`, "error");
                        return row;
                    }
                });

                this.exportExcel(resultData);
            }


            exportExcel(data) {
                const wb = XLSX.utils.book_new();
                wb.Workbook = {
                    Views: [{
                        RTL: true
                    }]
                };
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
                const wsData = [...data];
                // const totals = {
                //     'Ø§Ù„ØªØ§Ø±ÙŠØ®': 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',
                //     'vdep': 0,
                //     'vaccum': 0
                // };
                // data.forEach(r => {
                //     totals.vdep += (r['Ø§Ù‡Ù„Ø§Ùƒ Ø§Ù„ÙØªØ±Ø©'] || 0);
                //     totals.vaccum += (r['Ù…Ø®ØµØµ Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØªØ±Ø©'] || 0);
                // });
                // wsData.push(totals);

                const ws = XLSX.utils.json_to_sheet(wsData, {
                    origin: "A6"
                });

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
                XLSX.utils.sheet_add_aoa(ws, [
                    ["ØªÙ‚Ø±ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ Ø¹Ù† Ø§Ù„ÙØªØ±Ø© Ù…Ù† " + document.getElementById(`date_${document.querySelector('input[name="depper"]:checked').value}`).value +
                        " Ø¥Ù„Ù‰ " + document.getElementById(`end_${document.querySelector('input[name="depper"]:checked').value}`).value
                    ]
                ], {
                    origin: "C1"
                });

                // Ø¶Ø¨Ø· Ø§Ù„Ø§ØªØ¬Ø§Ù‡ RTL (Ø¹Ø¨Ø± Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù€ workbook)
                if (!wb.Workbook) wb.Workbook = {};
                if (!wb.Workbook.Views) wb.Workbook.Views = [{}];
                wb.Workbook.Views[0].rtl = true;

                // Ø¶Ø¨Ø· Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                const wscols = [];
                for (let i = 0; i < 20; i++) wscols.push({
                    wch: 15
                });
                ws['!cols'] = wscols;

                XLSX.utils.book_append_sheet(wb, ws, "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ");

                // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø­ÙˆØ±ÙŠØ© (Pivot Logic)
                this.addPivotSheet(wb, data, 'Ø§Ù„Ù†ÙˆØ¹', 'Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹');
                this.addPivotSheet(wb, data, 'Ù…Ø±ÙƒØ² ØªÙƒÙ„ÙØ©', 'Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ Ø­Ø³Ø¨ Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©');
                this.addPivotSheet(wb, data, 'Ø§Ù„ØªÙ…ÙˆÙŠÙ„', 'Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ Ø­Ø³Ø¨ Ø§Ù„ØªÙ…ÙˆÙŠÙ„(Ù‡Ø¯Ø§ÙŠØ§)');

                XLSX.writeFile(wb, `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ_2025.xlsx`);
                uiManager.log("ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù„Ù Ø§Ù„Ø§ÙƒØ³ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!", "success");
            }


            addPivotSheet(wb, data, key, sheetName) {
                const pivotMap = {};

                // 1. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Grouping & Aggregation)
                data.forEach(r => {
                    const k = r[key] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
                    if (!pivotMap[k]) {
                        pivotMap[k] = {
                            [key]: k,
                            'Ø§Ù„Ù‚ÙŠÙ…Ø©': 0,
                            'Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ': 0,
                            'Ù…Ø®ØµØµ Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ': 0
                        };
                    }
                    pivotMap[k]['Ø§Ù„Ù‚ÙŠÙ…Ø©'] += (parseFloat(r['Ø§Ù„Ù‚ÙŠÙ…Ø©']) || 0);
                    pivotMap[k]['Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ'] += (parseFloat(r['Ø§Ù‡Ù„Ø§Ùƒ Ø§Ù„ÙØªØ±Ø©']) || 0);
                    pivotMap[k]['Ù…Ø®ØµØµ Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ'] += (parseFloat(r['Ù…Ø®ØµØµ Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØªØ±Ø©']) || 0);
                });

                // 2. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ø¨ÙŠØ§Ù†Ø§Øª
                const pivotData = Object.values(pivotMap);

                // 3. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù… (Grand Totals)
                const grandTotal = {
                    [key]: 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù…',
                    'Ø§Ù„Ù‚ÙŠÙ…Ø©': 0,
                    'Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ': 0,
                    'Ù…Ø®ØµØµ Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ': 0
                };

                pivotData.forEach(row => {
                    grandTotal['Ø§Ù„Ù‚ÙŠÙ…Ø©'] += row['Ø§Ù„Ù‚ÙŠÙ…Ø©'];
                    grandTotal['Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ'] += row['Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ'];
                    grandTotal['Ù…Ø®ØµØµ Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ'] += row['Ù…Ø®ØµØµ Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ'];
                });

                // Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…ØµÙÙˆÙØ©
                pivotData.push(grandTotal);

                // 4. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¥Ù„Ù‰ Ø´ÙŠØª Ø¥ÙƒØ³ÙŠÙ„
                const ws = XLSX.utils.json_to_sheet(pivotData, {
                    origin: "A6" // ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³
                });

                // 5. Ø¶Ø¨Ø· Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø´ÙŠØª Ù„ÙŠØµØ¨Ø­ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø± ÙˆØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶
                // ws['!dir'] = "rtl";
                ws['!views'] = {
                    RTL: true
                };
                const wscols = [{
                        wch: 20
                    }, // Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ (Ø§Ù„Ø§Ø³Ù…)
                    {
                        wch: 15
                    }, // Ø§Ù„Ù‚ÙŠÙ…Ø©
                    {
                        wch: 15
                    }, // Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ
                    {
                        wch: 15
                    } // Ù…Ø®ØµØµ Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ
                ];
                ws['!cols'] = wscols;
                // 1. Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø£ÙˆÙ„Ø§Ù‹ ÙˆØªØ®Ø²ÙŠÙ†Ù‡Ø§ ÙÙŠ Ù…ØªØºÙŠØ±Ø§Øª Ù„Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯Ù‡Ø§
                const depperValue = document.querySelector('input[name="depper"]:checked').value;

                // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù‚ÙŠÙ… Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
                const dateVal = document.getElementById(`date_${depperValue}`).value;
                const endVal = document.getElementById(`end_${depperValue}`).value;

                // 2. ØªØ¬Ù‡ÙŠØ² Ù†Øµ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                // (ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…ØªØºÙŠØ± sheetName Ù…Ø¹Ø±Ù Ù„Ø¯ÙŠÙƒØŒ Ø£Ùˆ Ø¶Ø¹ Ø§Ø³Ù… Ø«Ø§Ø¨Øª Ù…Ø«Ù„ "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ù‡Ù„Ø§Ùƒ")
                const titleText = `${sheetName} Ø¹Ù† Ø§Ù„ÙØªØ±Ø© Ù…Ù† ${dateVal} Ø¥Ù„Ù‰ ${endVal}`;
                // 6. Ø¥Ø¶Ø§ÙØ© Ø§Ø³Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
                XLSX.utils.sheet_add_aoa(ws, [
                    [titleText]
                ], {
                    origin: "C1"
                });

                // 7. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´ÙŠØª Ø¥Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ø¹Ù…Ù„
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            }
        }
        const app = new DepreciationApp();
    </script>
</body>

</html>