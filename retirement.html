<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صائد العاملين - نظام التقاعد</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
         :root {
            --primary-color: #2c3e50;
            --accent-color: #e67e22;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333;
            --border-radius: 12px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: var(--text-color);
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        /* Header Styles */
        
        header {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        .logo-box,
        .profile-box {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-box img {
            max-width: 100%;
            max-height: 100%;
        }
        
        .profile-box img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent-color);
            box-shadow: 0 0 10px rgba(230, 126, 34, 0.4);
        }
        
        .app-info {
            text-align: center;
        }
        
        .app-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 0;
        }
        
        .copyright {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        /* Control Panel */
        
        .control-panel {
            background: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .date-input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        input[type="date"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            width: 100%;
            max-width: 300px;
            font-family: inherit;
        }
        /* Drag and Drop Area */
        
        .drop-zone {
            border: 2px dashed #bdc3c7;
            border-radius: var(--border-radius);
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #fafafa;
        }
        
        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: var(--accent-color);
            background: #fdf2e9;
        }
        
        .drop-text {
            font-size: 18px;
            color: #7f8c8d;
        }
        
        .btn-process {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            transition: background 0.3s;
            display: block;
        }
        
        .btn-process:hover {
            background-color: #34495e;
        }
        
        .btn-process:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        /* Console / Logs */
        
        .log-container {
            background: #2d3436;
            color: #00ff9d;
            padding: 20px;
            border-radius: var(--border-radius);
            font-family: 'Courier New', Courier, monospace;
            height: 300px;
            overflow-y: auto;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .log-entry {
            margin-bottom: 5px;
            border-bottom: 1px solid #444;
            padding-bottom: 2px;
        }
        
        .log-time {
            color: #fab1a0;
            margin-left: 10px;
        }
        
        .log-error {
            color: #ff7675;
            font-weight: bold;
        }
        
        .log-success {
            color: #55efc4;
        }
        /* Footer */
        
        footer {
            text-align: center;
            margin-top: 30px;
            font-size: 12px;
            color: #95a5a6;
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <div class="profile-box">
                <img src="https://talalcer.github.io/fuel-img/talal512.png" alt="Talal Cerity" class="profile-img">
                <!-- <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#2c3e50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 21h18M5 21V7l8-4 8 4v14M12 11v10" /> 
                </svg> -->
            </div>

            <div class="app-info">
                <h1 class="app-title">صائد العاملين الذين أتموا سن التقاعد</h1>
                <div class="copyright">الحقوق محفوظة طلال السريتي | talalcer@gmail.com</div>
            </div>

            <div class="profile-box">
                <img src="https://talalcer.github.io/fuel-img/mizan.png" alt="Talal Cerity" class="profile-img">
                <!-- <img src="https://ui-avatars.com/api/?name=Talal+S&background=e67e22&color=fff&size=128" alt="Talal Al-Suraiti"> -->
            </div>
        </header>

        <main class="control-panel">

            <div class="date-input-group">
                <label for="referenceDate">تاريخ حساب سن المعاش (اتركه فارغاً لاعتماد تاريخ اليوم):</label>
                <input type="date" id="referenceDate">
            </div>

            <div class="drop-zone" id="dropZone">
                <div class="drop-text">اضغط هنا لفتح ملف الإكسيل أو قم بسحبه وإفلاته هنا</div>
                <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;">
            </div>

            <button id="btnProcess" class="btn-process">بدء المعالجة واستخراج التقارير</button>
        </main>

        <div class="log-container" id="logConsole">
            <div class="log-entry"><span class="log-time">[System]</span> جاهز للعمل... بانتظار الملف.</div>
        </div>
    </div>

    <footer>
        Designed & Developed by Talal Cerity &copy; 2025
    </footer>

    <script>
        /**
         * ==========================================
         * OOP ARCHITECTURE
         * ==========================================
         */

        // 1. Logger Class: Handles UI Logging
        class Logger {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
            }

            log(message, type = 'info') {
                const now = new Date().toLocaleTimeString('ar-EG');
                const entry = document.createElement('div');
                entry.className = 'log-entry';

                let colorClass = '';
                if (type === 'error') colorClass = 'log-error';
                if (type === 'success') colorClass = 'log-success';

                entry.innerHTML = `<span class="log-time">[${now}]</span> <span class="${colorClass}">${message}</span>`;
                this.container.appendChild(entry);
                this.container.scrollTop = this.container.scrollHeight;
            }

            clear() {
                this.container.innerHTML = '';
            }
        }

        // 2. DataProcessor Class: Encapsulates Logic for ID Parsing and Rules
        class DataProcessor {
            constructor() {
                // ترتيب الحقول المتوقع في ملف الإدخال
                this.expectedHeaders = ['من الوحدة', 'الحالة', 'الدرجه الوظيفيه', 'الاسم', 'الرقم القومى', 'مسلسل'];
            }

            /**
             * Parse Egyptian National ID
             * @param {string} nid - National ID
             * @returns {Date|null}
             */
            extractBirthDate(nid) {
                if (!nid || String(nid).length !== 14) return null;

                const nidStr = String(nid);
                const centuryCode = parseInt(nidStr.substring(0, 1));
                const yearPart = nidStr.substring(1, 3);
                const monthPart = nidStr.substring(3, 5);
                const dayPart = nidStr.substring(5, 7);

                let century;
                if (centuryCode === 2) century = 1900;
                else if (centuryCode === 3) century = 2000;
                else return null; // Invalid century code

                const fullYear = century + parseInt(yearPart);
                const month = parseInt(monthPart) - 1; // JS months are 0-11
                const day = parseInt(dayPart);

                const date = new Date(fullYear, month, day);

                // Validate date
                if (date.getFullYear() === fullYear && date.getMonth() === month && date.getDate() === day) {
                    return date;
                }
                return null;
            }

            calculateAge(birthDate, referenceDate) {
                let age = referenceDate.getFullYear() - birthDate.getFullYear();
                const m = referenceDate.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && referenceDate.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            }

            formatDate(date) {
                return date.toISOString().split('T')[0]; // YYYY-MM-DD
            }
        }

        // 3. ExcelHandler Class: Encapsulates SheetJS operations
        class ExcelHandler {
            constructor() {}

            readFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, {
                                type: 'array'
                            });
                            resolve(workbook);
                        } catch (err) {
                            reject(err);
                        }
                    };
                    reader.onerror = (err) => reject(err);
                    reader.readAsArrayBuffer(file);
                });
            }

            generateSheetData(title, headers, dataRows) {
                // Create 5 rows for metadata
                const metadata = [
                    [], // Row 1
                    [], // Row 2
                    ["", "", title], // Row 3 (Title in Column C/3)
                    ["", "", `عدد السجلات: ${dataRows.length}`], // Row 4
                    [] // Row 5 (Empty spacer)
                ];

                return [...metadata, headers, ...dataRows];
            }

            createWorkbook(sheetsData) {
                const wb = XLSX.utils.book_new();
                wb.Workbook = {
                    Views: [{
                        RTL: true
                    }]
                }; // Set Global RTL

                sheetsData.forEach(sheetInfo => {
                    const ws = XLSX.utils.aoa_to_sheet(sheetInfo.data);

                    // Set Sheet Direction to RTL
                    if (!ws['!views']) ws['!views'] = [];
                    ws['!views'].push({
                        RTL: true
                    });

                    XLSX.utils.book_append_sheet(wb, ws, sheetInfo.name);
                });

                return wb;
            }

            downloadWorkbook(wb, filename) {
                XLSX.writeFile(wb, filename);
            }
        }

        // 4. Main App Controller
        class App {
            constructor() {
                this.logger = new Logger('logConsole');
                this.processor = new DataProcessor();
                this.excelHandler = new ExcelHandler();

                this.fileInput = document.getElementById('fileInput');
                this.dropZone = document.getElementById('dropZone');
                this.processBtn = document.getElementById('btnProcess');
                this.dateInput = document.getElementById('referenceDate');

                this.selectedFile = null;

                this.initEvents();
            }

            initEvents() {
                // Drag & Drop
                this.dropZone.addEventListener('click', () => this.fileInput.click());
                this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e.target.files[0]));

                this.dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.dropZone.classList.add('dragover');
                });

                this.dropZone.addEventListener('dragleave', () => {
                    this.dropZone.classList.remove('dragover');
                });

                this.dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.dropZone.classList.remove('dragover');
                    if (e.dataTransfer.files.length) {
                        this.handleFileSelect(e.dataTransfer.files[0]);
                    }
                });

                // Process Button
                this.processBtn.addEventListener('click', () => this.startProcessing());
            }

            handleFileSelect(file) {
                this.selectedFile = file;
                this.dropZone.querySelector('.drop-text').textContent = `تم تحديد الملف: ${file.name}`;
                this.logger.log(`تم تحميل الملف: ${file.name}`, 'success');
            }

            async startProcessing() {
                if (!this.selectedFile) {
                    this.logger.log("الرجاء اختيار ملف أولاً!", 'error');
                    return;
                }

                this.logger.clear();
                this.logger.log("بدء عملية المعالجة...", 'info');

                // Determine Reference Date
                let refDate = new Date();
                if (this.dateInput.value) {
                    refDate = new Date(this.dateInput.value);
                }
                this.logger.log(`تاريخ المرجعية المعتمد: ${refDate.toISOString().split('T')[0]}`);

                try {
                    // 1. Read File
                    const wb = await this.excelHandler.readFile(this.selectedFile);
                    const firstSheetName = wb.SheetNames[0];
                    const rawData = XLSX.utils.sheet_to_json(wb.Sheets[firstSheetName]);

                    this.logger.log(`تم قراءة ${rawData.length} سجل من الملف.`, 'info');

                    // 2. Process Data
                    const cleanData = [];
                    const retireesData = [];

                    // Output Headers (Reversed Logic per request if input is standard, but here we define explicit output order)
                    // The request said "reverse fields from left to right", I will arrange them logically RTL for the Arabic sheet
                    // Order: مسلسل, الرقم القومى, الاسم, الدرجة, الحالة, الوحدة, تاريخ الميلاد
                    const outputHeaders = ['مسلسل', 'الرقم القومى', 'الاسم', 'الدرجه الوظيفيه', 'الحالة', 'من الوحدة', 'تاريخ الميلاد'];

                    rawData.forEach((row, index) => {
                        const rowNum = index + 2; // Excel row number approximation
                        try {
                            // Normalize keys (trim spaces)
                            const safeRow = {};
                            Object.keys(row).forEach(k => safeRow[k.trim()] = row[k]);

                            // Extract Data
                            const id = safeRow['الرقم القومى'];
                            const status = safeRow['الحالة'] ? safeRow['الحالة'].trim() : "";

                            // Logic: Parse Date
                            let dob = null;
                            let dobString = "خطأ في الرقم القومي";

                            if (id) {
                                dob = this.processor.extractBirthDate(id);
                            }

                            if (dob) {
                                dobString = this.processor.formatDate(dob);

                                // Check Retirement
                                const age = this.processor.calculateAge(dob, refDate);

                                // Prepare Row Array (aligned with outputHeaders)
                                const processedRow = [
                                    safeRow['مسلسل'],
                                    id,
                                    safeRow['الاسم'],
                                    safeRow['الدرجه الوظيفيه'],
                                    status,
                                    safeRow['من الوحدة'],
                                    dobString
                                ];

                                cleanData.push(processedRow);

                                // Filter Logic: Age >= 60 AND Status == "غير موقوف"
                                if (age >= 60) {
                                    if (status === "غير موقوف") {
                                        retireesData.push(processedRow);
                                        this.logger.log(`تم اصطياد متقاعد: ${safeRow['الاسم']} (الصف ${rowNum})`, 'success');
                                    } else {
                                        // Log if retired but suspended (optional, for debugging)
                                        // this.logger.log(`تجاوز سن التقاعد ولكن موقوف: ${safeRow['الاسم']}`, 'warning');
                                    }
                                }

                            } else {
                                throw new Error(`الرقم القومي غير صالح: ${id}`);
                            }

                        } catch (err) {
                            this.logger.log(`خطأ في الصف ${rowNum}: ${err.message}`, 'error');
                            // Even with error, we might want to add to clean data with error note? 
                            // Requirement says: "Don't stop, catch error, write error".
                            // Adding row with Error in DOB column
                            const safeRow = row; // Fallback
                            const processedRow = [
                                safeRow['مسلسل'] || '',
                                safeRow['الرقم القومى'] || '',
                                safeRow['الاسم'] || '',
                                safeRow['الدرجه الوظيفيه'] || '',
                                safeRow['الحالة'] || '',
                                safeRow['من الوحدة'] || '',
                                `خطأ: ${err.message}`
                            ];
                            cleanData.push(processedRow);
                        }
                    });

                    // 3. Generate Output
                    this.logger.log("جاري إعداد ملف الإكسيل...", 'info');

                    const sheet1Data = this.excelHandler.generateSheetData("تقرير البيانات النظيفة", outputHeaders, cleanData);
                    const sheet2Data = this.excelHandler.generateSheetData("تقرير العاملين غير الموقوفين (فوق 60)", outputHeaders, retireesData);

                    const newWb = this.excelHandler.createWorkbook([{
                        name: "بيانات نظيفة",
                        data: sheet1Data
                    }, {
                        name: "عاملين غير موقوفين",
                        data: sheet2Data
                    }]);

                    // 4. Download
                    this.excelHandler.downloadWorkbook(newWb, "RetireeHunter_Report.xlsx");
                    this.logger.log("تم استخراج التقرير بنجاح!", 'success');
                    this.logger.log(`عدد السجلات الكلية: ${cleanData.length}`);
                    this.logger.log(`عدد المتقاعدين (غير موقوفين): ${retireesData.length}`);


                } catch (globalError) {
                    this.logger.log(`خطأ جسيم في المعالجة: ${globalError.message}`, 'error');
                    console.error(globalError);
                }
            }
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            const app = new App();
        });
    </script>

</body>

</html>