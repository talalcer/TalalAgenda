<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محلل استمارة 75</title>

    <link rel="manifest" id="my-manifest">

    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           CSS Styles (التصميم)
           ========================================= */
        
         :root {
            --primary-color: #2c3e50;
            --accent-color: #27ae60;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333;
            --error-color: #c0392b;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            user-select: none;
            /* Prevent text selection */
        }
        /* Header & Logos */
        
        header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .logo-box {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .app-info {
            text-align: center;
        }
        
        .app-info h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 800;
        }
        
        .app-info p {
            margin: 5px 0 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .visitor-count {
            margin-top: 5px;
            font-size: 0.8rem;
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 10px;
            border-radius: 15px;
        }
        /* Main Content */
        
        main {
            flex: 1;
            max-width: 1000px;
            margin: 2rem auto;
            width: 95%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        
        .description-text {
            color: #555;
            line-height: 1.6;
            margin-bottom: 20px;
            border-right: 4px solid var(--accent-color);
            padding-right: 15px;
            text-align: right;
        }
        /* Drag & Drop Zone */
        
        .drop-zone {
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            padding: 40px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: var(--accent-color);
            background-color: rgba(39, 174, 96, 0.05);
        }
        
        .drop-zone p {
            font-size: 1.1rem;
            color: #7f8c8d;
        }
        
        #fileInput {
            display: none;
        }
        /* Button */
        
        .process-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 40px;
            font-size: 1.1rem;
            border-radius: 30px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            margin-top: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            max-width: 300px;
        }
        
        .process-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }
        
        .process-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        /* Logger */
        
        .log-container {
            background: #2d3436;
            color: #dfe6e9;
            padding: 15px;
            border-radius: 8px;
            height: 250px;
            overflow-y: auto;
            text-align: right;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            border: 1px solid #444;
        }
        
        .log-entry {
            margin-bottom: 5px;
            border-bottom: 1px solid #444;
            padding-bottom: 2px;
        }
        
        .log-time {
            color: #81ecec;
            margin-left: 10px;
        }
        
        .log-error {
            color: #ff7675;
            font-weight: bold;
        }
        
        .log-success {
            color: #55efc4;
        }
        /* Footer */
        
        footer {
            background: #2c3e50;
            color: white;
            text-align: center;
            padding: 1rem;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 15px;
            }
            .logo-box {
                width: 70px;
                height: 70px;
            }
        }
    </style>

    <script>
        /* =========================================
                                                   Security & Initialization (الأمان والتهيئة)
                                                   ========================================= */

        // 1. منع أدوات التطوير (Context Menu, F12)
        document.addEventListener('contextmenu', event => event.preventDefault());

        document.addEventListener('keydown', function(e) {
            // F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
            if (e.key === 'F12' ||
                (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) ||
                (e.ctrlKey && e.key === 'U')) {
                e.preventDefault();
                return false;
            }
        });

        // 2. إنشاء ملف PWA Manifest ديناميكياً
        const manifest = {
            "name": "محلل استمارة 75",
            "short_name": "تحليل75",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#f4f7f6",
            "theme_color": "#2c3e50",
            "icons": [{
                "src": "https://talalcer.github.io/fuel-img/mizan.png",
                "sizes": "192x192",
                "type": "image/png"
            }]
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {
            type: 'application/json'
        });
        const manifestURL = URL.createObjectURL(blob);

        window.addEventListener('load', () => {
            document.querySelector('#my-manifest').setAttribute('href', manifestURL);
        });
    </script>
</head>

<body>

    <header>
        <div class="header-container">
            <div class="logo-box">
                <img src="https://talalcer.github.io/fuel-img/mizan.png" alt="Company Logo">
            </div>

            <div class="app-info">
                <h1>محلل استمارة 75</h1>
                <p>Talal Cerity &copy; 2025</p>
                <div class="visitor-count" id="visitor-counter">جاري تحميل الزوار...</div>
            </div>

            <div class="logo-box">
                <img src="https://talalcer.github.io/fuel-img/talal512.png" alt="Talal Cerity">
            </div>
        </div>
    </header>

    <main>
        <div class="card">
            <div class="description-text">
                <h3>عن التطبيق</h3>
                <p>هذا التطبيق يقوم بتحليل استمارة 75 واستخراج الحسابات الرئيسية والفرعية والارصدة الشاذة وتصنيف الابواب والحسابات النظامية بشكل آلي ودقيق.</p>
            </div>

            <div class="drop-zone" id="dropZone">
                <p>اضغط هنا لاختيار ملف Excel أو قم بسحبه وإفلاته هنا</p>
                <input type="file" id="fileInput" accept=".xlsx, .xls" />
            </div>

            <button id="processBtn" class="process-btn" disabled>بدء المعالجة</button>
        </div>

        <div class="log-container" id="logConsole">
            <div class="log-entry"><span class="log-time">System:</span> بانتظار الملف...</div>
        </div>
    </main>

    <footer>
        <p>الحقوق محفوظة &copy; طلال السريتي | talalcer@gmail.com | Talal Cerity</p>
    </footer>

    <script>
        /**
         * =========================================
         * Logic Core (OOP Implementation)
         * =========================================
         */

        // --- 1. UI Manager Class: التعامل مع الواجهة ---
        class UIManager {
            constructor() {
                this.dropZone = document.getElementById('dropZone');
                this.fileInput = document.getElementById('fileInput');
                this.processBtn = document.getElementById('processBtn');
                this.logConsole = document.getElementById('logConsole');
                this.visitorEl = document.getElementById('visitor-counter');

                this.initEventListeners();
                this.fetchVisitorCount();
            }

            initEventListeners() {
                // Click to upload
                this.dropZone.addEventListener('click', () => this.fileInput.click());

                // Drag & Drop visual effects
                this.dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.dropZone.classList.add('dragover');
                });
                this.dropZone.addEventListener('dragleave', () => {
                    this.dropZone.classList.remove('dragover');
                });

                // File Drop
                this.dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.dropZone.classList.remove('dragover');
                    if (e.dataTransfer.files.length) {
                        this.handleFiles(e.dataTransfer.files[0]);
                    }
                });

                // File Input Change
                this.fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length) {
                        this.handleFiles(e.target.files[0]);
                    }
                });

                // Process Button
                this.processBtn.addEventListener('click', () => {
                    if (this.selectedFile) {
                        app.processor.processFile(this.selectedFile);
                    }
                });
            }

            handleFiles(file) {
                this.selectedFile = file;
                this.log(`تم اختيار الملف: ${file.name}`, 'info');
                this.processBtn.disabled = false;
                this.dropZone.querySelector('p').innerText = `ملف جاهز: ${file.name}`;
            }

            log(message, type = 'info') {
                const div = document.createElement('div');
                div.className = 'log-entry';
                const time = new Date().toLocaleTimeString('en-GB');

                let content = `<span class="log-time">[${time}]</span> ${message}`;
                if (type === 'error') div.classList.add('log-error');
                if (type === 'success') div.classList.add('log-success');

                div.innerHTML = content;
                this.logConsole.appendChild(div);
                this.logConsole.scrollTop = this.logConsole.scrollHeight;
            }

            async fetchVisitorCount() {
                try {
                    // ملاحظة: قراءة الملف فقط. لزيادة العدد فعلياً نحتاج Backend
                    // سنقوم بمحاكاة الزيادة محلياً للعرض
                    const response = await fetch('https://talalcer.github.io/visitor.json');
                    if (response.ok) {
                        const data = await response.json();
                        // افترضنا ان ملف الجيسون به مفتاح count او ما شابه
                        // إذا لم نتمكن من الكتابة على السيرفر، سنعرض الرقم + 1
                        let count = data.count || data.visitors || 1500;
                        this.visitorEl.innerText = `عدد الزائرين: ${count + 1}`;
                    } else {
                        throw new Error("Network response was not ok");
                    }
                } catch (e) {
                    this.visitorEl.innerText = "عدد الزائرين: غير متاح";
                    // لا نوقف التطبيق بسبب فشل العداد
                }
            }
        }

        // --- 2. Data Models (Encapsulation) ---
        class RowData {
            constructor(code, desc, d1, c1, d2, c2, d3, c3) {
                this.rawCode = code || "";
                this.code = this.cleanCode(code); // 8 chars from right
                this.description = desc || "";

                // تحويل الأرقام
                this.debitFirst = this.parseNumber(d1);
                this.creditFirst = this.parseNumber(c1);
                this.debitMove = this.parseNumber(d2);
                this.creditMove = this.parseNumber(c2);
                this.debitLast = this.parseNumber(d3);
                this.creditLast = this.parseNumber(c3);
            }

            cleanCode(val) {
                if (!val) return "";
                let str = val.toString().trim();
                // استخراج 8 حروف من اليمين
                if (str.length > 8) {
                    return str.slice(-8);
                }
                return str;
            }

            parseNumber(val) {
                if (!val) return 0;
                if (typeof val === 'number') return val;
                // تنظيف النص من الفواصل والمسافات
                let clean = val.toString().replace(/,/g, '').trim();
                let num = parseFloat(clean);
                return isNaN(num) ? 0 : num;
            }

            // تحويل البيانات لصف مصفوفة للإخراج
            toArray() {
                // تنسيق الأرقام الكبيرة (مثل القومي) يتم عبر SheetJS cell format
                // هنا نرجع القيم الخام
                return [
                    this.code,
                    this.description,
                    this.debitFirst,
                    this.creditFirst,
                    this.debitMove,
                    this.creditMove,
                    this.debitLast,
                    this.creditLast
                ];
            }
        }

        // --- 3. Excel Processor Class ---
        class ExcelProcessor {
            constructor(ui) {
                this.ui = ui;
                this.HEADERS = ["الكود", "البيان", "مدين اول", "دائن اول", "حركة مدين", "حركة دائن", "مدين اخر", "دائن اخر"];
            }

            processFile(file) {
                this.ui.log("بدأ قراءة الملف...", 'info');
                const reader = new FileReader();

                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {
                            type: 'array'
                        });

                        // افتراض أن البيانات في أول شيت
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];

                        this.processData(worksheet);

                    } catch (error) {
                        this.ui.log(`خطأ جسيم أثناء قراءة الملف: ${error.message}`, 'error');
                    }
                };

                reader.onerror = () => this.ui.log("فشل في قراءة الملف.", 'error');
                reader.readAsArrayBuffer(file);
            }

            processData(worksheet) {
                this.ui.log("بدأ معالجة البيانات...", 'info');

                // تحويل الشيت إلى JSON (مصفوفة مصفوفات)
                // header: 1 يعطي مصفوفة لكل صف
                const rawData = XLSX.utils.sheet_to_json(worksheet, {
                    header: 1
                });

                if (rawData.length < 13) { // 9 header + 1 data + 3 footer min
                    this.ui.log("الملف صغير جداً ولا يحتوي بيانات كافية.", 'error');
                    return;
                }

                // 1. استخراج البيانات (تخطي 9 صفوف وحذف آخر 3)
                const startRow = 10; // Index 9 means Row 10
                const endRow = rawData.length - 3;

                let cleanedRows = [];

                for (let i = startRow; i < endRow; i++) {
                    const row = rawData[i];
                    if (!row || row.length === 0) continue;

                    try {
                        // الأعمدة حسب الهيكل: كود، بيان، م، د، م، د، م، د (8 أعمدة)
                        // نتأكد من وجود البيانات وتفادي الأخطاء في صف معين
                        let rowObj = new RowData(
                            row[0], row[1], row[2], row[3], row[4], row[5], row[6], row[7]
                        );
                        cleanedRows.push(rowObj);
                    } catch (err) {
                        this.ui.log(`خطأ في معالجة الصف رقم ${i+1}: ${err.message}`, 'error');
                        // Continue processing (لا تتوقف)
                    }
                }

                this.ui.log(`تم استخراج ${cleanedRows.length} سجل نظيف.`, 'success');

                // 2. تصنيف البيانات (Logic Filters)
                this.generateReports(cleanedRows);
            }

            generateReports(allData) {
                try {
                    const wb = XLSX.utils.book_new();
                    wb.Workbook = {
                        Views: [{
                            RTL: true
                        }]
                    }; // تفعيل RTL للكتاب بالكامل

                    // --- أ. شيت بيانات نظيفة ---
                    this.addSheetToWorkbook(wb, allData, "بيانات نظيفة", "تقرير البيانات النظيفة");

                    // --- ب. حسابات رئيسية ---
                    // اول رقمين من اليمين "00" ويليهما (الثالث من اليمين) ليس 0
                    const mainAccounts = allData.filter(r => {
                        const str = r.code;
                        if (str.length < 3) return false;
                        return str.endsWith("00") && str.charAt(str.length - 3) !== '0';
                    });
                    this.addSheetToWorkbook(wb, mainAccounts, "حسابات رئيسية", "تقرير الحسابات الرئيسية");

                    // --- ج. حسابات فرعية ---
                    // اول رقمين من اليمين ليس "00"
                    const subAccounts = allData.filter(r => !r.code.endsWith("00"));
                    this.addSheetToWorkbook(wb, subAccounts, "حسابات فرعية", "تقرير الحسابات الفرعية");

                    // --- د. ارصدة شاذة ---
                    // من الحسابات الفرعية
                    // 1- اول رقم يسار 1 وله رصيد مدين اخر (ملاحظة: حسب الطلب حرفياً)
                    // 2- اول رقم يسار 2 وله رصيد دائن اخر
                    // 3- اول رقم يسار 3 وله رصيد دائن اخر
                    // 4- اول رقم يسار 4 وله رصيد مدين اخر
                    const abnormal = subAccounts.filter(r => {
                        const firstChar = r.code.charAt(0); // Leftmost
                        if (firstChar === '1' && r.debitLast > 0) return true;
                        if (firstChar === '2' && r.creditLast > 0) return true;
                        if (firstChar === '3' && r.creditLast > 0) return true;
                        if (firstChar === '4' && r.debitLast > 0) return true;
                        return false;
                    });
                    this.addSheetToWorkbook(wb, abnormal, "ارصدة شاذة", "تقرير الأرصدة الشاذة (حسب المعايير المحددة)");

                    // --- هـ. ابواب ---
                    // اول 5 ارقام من اليمين 00000 ويليهما غير 0
                    const chapters = allData.filter(r => {
                        const str = r.code;
                        if (str.length < 6) return false;
                        return str.endsWith("00000") && str.charAt(str.length - 6) !== '0';
                    });
                    this.addSheetToWorkbook(wb, chapters, "ابواب", "تقرير الأبواب");

                    // --- و. حسابات نظامية ---
                    // اول رقم يسار 9
                    const regular = allData.filter(r => r.code.startsWith('9'));
                    this.addSheetToWorkbook(wb, regular, "حسابات نظامية", "تقرير الحسابات النظامية");

                    // الحفظ
                    this.ui.log("جاري حفظ ملف الإكسيل...", 'info');
                    XLSX.writeFile(wb, "تقرير_تحليل_استمارة75.xlsx");
                    this.ui.log("تمت العملية بنجاح!", 'success');

                } catch (e) {
                    this.ui.log(`حدث خطأ أثناء إنشاء التقارير: ${e.message}`, 'error');
                }
            }

            addSheetToWorkbook(wb, dataObjects, sheetName, reportTitle) {
                // تحويل الكائنات لمصفوفات بيانات
                const dataRows = dataObjects.map(obj => obj.toArray());

                // إنشاء الشيت
                const ws = XLSX.utils.aoa_to_sheet([]);

                // 1. إعداد العنوان (يبدأ من العمود الثالث في أول 5 صفوف)
                // نضع العنوان في الخلية C1 (Index 0, 2)
                XLSX.utils.sheet_add_aoa(ws, [
                    [reportTitle]
                ], {
                    origin: "C1"
                });

                // 2. إعداد الهيدر (تحت العنوان، لنقل الصف 6 مثلاً او كما طلبت مساحة 5 صفوف)
                // البيانات تبدأ بعد 5 صفوف، يعني الهيدر في الصف 6 (Index 5)
                XLSX.utils.sheet_add_aoa(ws, [this.HEADERS], {
                    origin: "A6"
                });

                // 3. إضافة البيانات
                XLSX.utils.sheet_add_aoa(ws, dataRows, {
                    origin: "A7"
                });

                // 4. التنسيق (Column Width)
                const wscols = this.HEADERS.map(() => ({
                    wch: 17
                })); // Max width logic approx
                ws['!cols'] = wscols;

                // 5. اتجاه الورقة RTL
                if (!ws['!views']) ws['!views'] = [];
                ws['!views'].push({
                    rightToLeft: true
                });

                // إضافة الشيت للملف
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            }
        }

        // --- 4. Main Application Entry Point ---
        const app = {
            init: function() {
                this.ui = new UIManager();
                this.processor = new ExcelProcessor(this.ui);
                console.log("Application Started");
            }
        };

        // Start App
        app.init();
    </script>
</body>

</html>