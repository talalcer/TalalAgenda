<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>إجراءات وخطوات مراجعة | Talal Cerity</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
         :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --bg-color: #ecf0f1;
            --text-color: #2c3e50;
            --sidebar-width: 300px;
            --header-height: 80px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100dvh;
            /* استخدام dvh لدعم متصفحات الموبايل بشكل أفضل */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        /* --- Header Styles --- */
        
        header {
            height: var(--header-height);
            background: linear-gradient(135deg, #ffffff 0%, #f1f1f1 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 10;
            flex-shrink: 0;
        }
        
        .header-content {
            text-align: center;
        }
        
        h1 {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 2px;
        }
        
        .subtitle {
            font-size: 0.7rem;
            color: #7f8c8d;
        }
        
        .logo-container {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--accent-color);
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .logo-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* --- Main Layout --- */
        
        main {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        /* Sidebar */
        
        aside {
            width: var(--sidebar-width);
            background: white;
            border-left: 1px solid #ddd;
            overflow-y: auto;
            padding: 15px;
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 20;
        }
        /* Toggle Button */
        
        #toggle-sidebar {
            position: absolute;
            right: 0;
            top: 20px;
            background: var(--accent-color);
            color: white;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px 0 0 5px;
            display: none;
            z-index: 30;
            font-size: 0.9rem;
            box-shadow: -2px 2px 5px rgba(0, 0, 0, 0.2);
        }
        /* Viewer Area */
        
        #viewer-container {
            flex: 1;
            background: #525659;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            overflow: hidden;
            width: 100%;
        }
        
        .toolbar {
            width: 100%;
            background: #333;
            color: white;
            padding: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .toolbar button {
            background: var(--accent-color);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .page-input {
            width: 40px;
            text-align: center;
            border-radius: 4px;
            border: none;
            padding: 3px;
        }
        /* Canvas Wrapper */
        
        #canvas-wrapper {
            flex: 1;
            width: 100%;
            overflow: auto;
            display: flex;
            justify-content: center;
            padding: 10px;
            /* السماح بالتمرير باللمس بسلاسة */
            -webkit-overflow-scrolling: touch;
        }
        
        #the-canvas {
            display: block;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            /* مهم جداً للموبايل: يمنع الكانفاس من تجاوز عرض الحاوية */
            max-width: 100%;
            height: auto;
        }
        
        .doc-link {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-right: 4px solid var(--accent-color);
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .doc-link:active,
        .doc-link:hover {
            background: var(--accent-color);
            color: white;
        }
        /* --- Mobile Responsive --- */
        
        @media (max-width: 768px) {
            header {
                height: 60px;
                padding: 0 10px;
            }
            .logo-container {
                width: 40px;
                height: 40px;
            }
            h1 {
                font-size: 0.9rem;
            }
            .subtitle {
                display: none;
            }
            /* القائمة الجانبية في الموبايل تغطي الشاشة بالكامل أو جزء منها */
            aside {
                position: absolute;
                top: 0;
                right: 0;
                width: 80%;
                height: 100%;
                box-shadow: -5px 0 15px rgba(0, 0, 0, 0.2);
                transform: translateX(100%);
                /* مخفية افتراضياً */
            }
            /* كلاس لإظهار القائمة */
            aside.active {
                transform: translateX(0);
            }
            /* زر القائمة يظهر دائماً في الموبايل */
            #toggle-sidebar {
                display: block;
            }
            /* تعديل العرض عند إخفاء القائمة */
            main.shrunk aside {
                transform: translateX(100%);
                /* إخفاء */
            }
            /* تراكب (Overlay) للخلفية عند فتح القائمة */
            #overlay {
                display: none;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 15;
            }
            #overlay.active {
                display: block;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="logo-container">
            <img src="https://talalcer.github.io/fuel-img/mizan.png" alt="Company Logo">
        </div>
        <div class="header-content">
            <h1>إجراءات وخطوات مراجعة</h1>
            <div class="subtitle">Talal Cerity</div>
        </div>
        <div class="logo-container">
            <img src="https://talalcer.github.io/fuel-img/auditortool5.png" alt="Talal Cerity">
        </div>
    </header>

    <main id="main-layout" class="shrunk">
        <div id="toggle-sidebar" onclick="app.ui.toggleSidebar()">☰ القائمة</div>

        <div id="overlay" onclick="app.ui.toggleSidebar()"></div>

        <aside id="links-sidebar">
            <h3 style="margin-bottom: 10px; text-align: center; color:#7f8c8d;">الملفات</h3>
        </aside>

        <section id="viewer-container">
            <div class="toolbar" id="toolbar" style="display:none;">
                <button onclick="app.viewer.prevPage()">السابق</button>
                <span dir="ltr"><input type="number" id="page_num" class="page-input" value="1"> / <span id="page_count">--</span></span>
                <button onclick="app.viewer.nextPage()">التالي</button>
            </div>

            <div id="canvas-wrapper">
                <canvas id="the-canvas"></canvas>
            </div>

            <div id="loading-msg" style="color:white; margin-top:50px;">اختر ملفاً للعرض...</div>
        </section>
    </main>

    <script>
        class PDFViewer {
            constructor() {
                this.pdfDoc = null;
                this.pageNum = 1;
                this.pageRendering = false;
                this.pageNumPending = null;
                this.canvas = document.getElementById('the-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.wrapper = document.getElementById('canvas-wrapper');

                // إعادة الرسم عند تغيير حجم النافذة (تدوير الهاتف)
                window.addEventListener('resize', () => {
                    if (this.pdfDoc) {
                        // استخدام debounce بسيط لمنع التقطيع
                        clearTimeout(this.resizeTimeout);
                        this.resizeTimeout = setTimeout(() => this.renderPage(this.pageNum), 200);
                    }
                });

                document.getElementById('page_num').addEventListener('change', (e) => {
                    let num = parseInt(e.target.value);
                    if (this.pdfDoc && num > 0 && num <= this.pdfDoc.numPages) {
                        this.pageNum = num;
                        this.renderPage(this.pageNum);
                    }
                });
            }

            async loadDocument(filename) {
                const url = `${window.Config.folder}/${filename}${window.Config.extension}`;
                document.getElementById('loading-msg').style.display = 'block';
                document.getElementById('loading-msg').innerText = 'جاري التحميل...';
                document.getElementById('toolbar').style.display = 'none';
                this.canvas.style.display = 'none';

                try {
                    // محاكاة جلب الكونفج إذا لم يكن موجوداً للتجربة المباشرة
                    if (!window.Config) window.Config = {
                        folder: '.',
                        extension: '.pdf'
                    };

                    const loadingTask = pdfjsLib.getDocument(url);
                    this.pdfDoc = await loadingTask.promise;

                    document.getElementById('page_count').textContent = this.pdfDoc.numPages;
                    document.getElementById('loading-msg').style.display = 'none';
                    document.getElementById('toolbar').style.display = 'flex';
                    this.canvas.style.display = 'block';

                    this.pageNum = 1;
                    this.renderPage(this.pageNum);
                } catch (error) {
                    console.error(error);
                    document.getElementById('loading-msg').innerText = 'خطأ: ' + error.message;
                }
            }

            renderPage(num) {
                this.pageRendering = true;

                this.pdfDoc.getPage(num).then((page) => {
                    // 1. حساب المقياس بناءً على عرض الشاشة المتاح
                    const containerWidth = this.wrapper.clientWidth - 20; // طرح الهوامش
                    const unscaledViewport = page.getViewport({
                        scale: 1
                    });

                    // حساب النسبة المطلوبة: عرض الحاوية / عرض الصفحة الأصلي
                    let scale = containerWidth / unscaledViewport.width;

                    // تحسين: إذا كانت الشاشة كبيرة جداً (سطح مكتب)، لا تجعل الصفحة ضخمة جداً
                    if (scale > 1.5) scale = 1.5;

                    const viewport = page.getViewport({
                        scale: scale
                    });

                    this.canvas.height = viewport.height;
                    this.canvas.width = viewport.width;

                    const renderContext = {
                        canvasContext: this.ctx,
                        viewport: viewport
                    };

                    const renderTask = page.render(renderContext);

                    renderTask.promise.then(() => {
                        this.pageRendering = false;
                        document.getElementById('page_num').value = num;

                        // تمرير للأعلى عند تغيير الصفحة في الموبايل
                        this.wrapper.scrollTop = 0;

                        if (this.pageNumPending !== null) {
                            this.renderPage(this.pageNumPending);
                            this.pageNumPending = null;
                        }
                    });
                });
            }

            queueRenderPage(num) {
                if (this.pageRendering) {
                    this.pageNumPending = num;
                } else {
                    this.renderPage(num);
                }
            }

            prevPage() {
                if (!this.pdfDoc || this.pageNum <= 1) return;
                this.pageNum--;
                this.queueRenderPage(this.pageNum);
            }

            nextPage() {
                if (!this.pdfDoc || this.pageNum >= this.pdfDoc.numPages) return;
                this.pageNum++;
                this.queueRenderPage(this.pageNum);
            }
        }

        class UIManager {
            constructor(viewerInstance) {
                this.viewer = viewerInstance;
                this.sidebar = document.getElementById('links-sidebar');
                this.overlay = document.getElementById('overlay');
                this.loadConfigAndInit();
            }

            async loadConfigAndInit() {
                try {
                    const response = await fetch('https://talalcer.github.io/auditproclink.json');
                    if (!response.ok) throw new Error('Failed to load config');
                    window.Config = await response.json();
                    this.initLinks();
                } catch (error) {
                    console.error('Config Error:', error);
                    // بيانات تجريبية في حالة فشل التحميل (لغرض الاختبار)
                    window.Config = {
                        folder: "docs",
                        extension: ".pdf",
                        links: [{
                            title: "ملف تجريبي 1",
                            file: "sample1"
                        }, {
                            title: "ملف تجريبي 2",
                            file: "sample2"
                        }]
                    };
                    // إزالة هذا السطر في الإنتاج إذا كنت تريد إظهار خطأ فقط
                    // this.initLinks(); 
                    this.sidebar.innerHTML += '<div style="color:red; text-align:center">تأكد من ملف auditproclink.json</div>';
                }
            }

            initLinks() {
                if (!window.Config || !window.Config.links) return;

                window.Config.links.forEach(link => {
                    const btn = document.createElement('div');
                    btn.className = 'doc-link';
                    btn.innerText = link.title;
                    btn.onclick = () => {
                        this.handleLinkClick(link.file);
                    };
                    this.sidebar.appendChild(btn);
                });
            }

            handleLinkClick(filename) {
                // إغلاق القائمة في الموبايل عند الاختيار
                if (window.innerWidth <= 768) {
                    this.toggleSidebar(false);
                }
                this.viewer.loadDocument(filename);
            }

            toggleSidebar(forceState) {
                const aside = document.querySelector('aside');
                const isMobile = window.innerWidth <= 768;

                if (isMobile) {
                    if (typeof forceState === 'boolean') {
                        forceState ? aside.classList.add('active') : aside.classList.remove('active');
                        forceState ? this.overlay.classList.add('active') : this.overlay.classList.remove('active');
                    } else {
                        aside.classList.toggle('active');
                        this.overlay.classList.toggle('active');
                    }
                } else {
                    // Logic for desktop (shrink)
                    document.getElementById('main-layout').classList.toggle('shrunk');
                }
            }
        }

        const app = {
            viewer: new PDFViewer(),
            ui: null
        };

        window.addEventListener('DOMContentLoaded', () => {
            app.ui = new UIManager(app.viewer);
        });
    </script>
</body>

</html>

